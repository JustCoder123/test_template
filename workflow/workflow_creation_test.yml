---
# - hosts: localhost
#   connection: local

 
#   tasks:
        - include_vars: vars.yml

        - name : Configuring {{workflow_template_name}}.
          uri :
            url : "http://{{tower_url}}/api/v2/workflow_job_templates/"
            user: "{{login_user}}"
            password: "{{login_password}}"
            force_basic_auth: yes
            method : POST
            body : {
                        "description": "Generating Workflow Template",
                        "name": "{{workflow_template_name}}",
                         "spec": [
                                   "name": "{{workflow_template_name}}",
                                    "description": "",
                                    "extra_vars": "",
                                    "organization": "{{org_id}}",
                                    "survey_enabled": true,
                                    "allow_simultaneous": false,
                                    "ask_variables_on_launch": true,
                                    "inventory": "{{inventory_id}}",
                                    "limit": "",
                                    "scm_branch": "",
                                    "ask_inventory_on_launch": false,
                                    "ask_scm_branch_on_launch": false,
                                    "ask_limit_on_launch": false,
                                    "webhook_service": null,
                                    "webhook_credential": null
                                                                  ]
                    }
            status_code: 201
            validate_certs : no
            body_format: json
          register : workflow_id_out 

        - set_fact:  
              workflow_id: "{{ workflow_id_out.json.id }}"

        - name : Adding First JobTempalte to {{ workflow_template_name }}
          uri :
            url : "http://{{tower_url}}/api/v2/workflow_job_templates/{{ workflow_id_out.json.id }}/workflow_nodes/"
            user: "{{login_user}}"
            password: "{{login_password}}"
            force_basic_auth: yes
            method : POST
            headers :
                 Content-Type : application/json
            body :  {
              "extra_data": { "login_user": "admin", "login_password": 12345},
              "inventory": null,
              "scm_branch": null,
              "job_type": null,
              "job_tags": null,
              "skip_tags": null,
              "limit": null,
              "diff_mode": null,
              "verbosity": null ,
              "workflow_job_template": " {{ workflow_id_out.json.id }} ",
              "unified_job_template": "{{ job_template_id }}",
              "success_nodes": [],
              "failure_nodes": [],
              "always_nodes": [],
              "all_parents_must_converge": false,
            }
                     
            status_code: 201
            validate_certs : no
            body_format: json
          register: workflow_node1_out

        # - debug:
        #    var : workflow_node1_out
        - set_fact:
              workflow_node: "{{workflow_node1_out.json.id}}"  

        - include_tasks: get_job_template_id.yml
        
        - debug:
            var: job_template_id_list

        
        - include_tasks: add_jobTemplate.yml
          vars: 
            previous_id: "{{workflow_node}}"
            template_id: "{{item}}"
          loop: "{{ job_template_id_list}}"


      
